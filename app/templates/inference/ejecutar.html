{% extends "basic.html" %}

{% block title %}
Inferencia – {{ modelo.nombre }}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 col-md-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> Ingresar Evidencia</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Seleccione el estado actual de los componentes observados.</p>
                
                <form method="post">
                    {% if nodos_para_input %}
                        {% for nombre_nodo, data in nodos_para_input.items() %}
                            {% if nombre_nodo != 'Disponibilidad' and data.states %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">{{ nombre_nodo }}</label>
                                <select name="{{ nombre_nodo }}" class="form-select form-select-sm">
                                    <option value="">-- Desconocido / Sin observación --</option>
                                    {% for estado in data.states %}
                                        <option value="{{ estado }}">{{ estado }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning">
                            El modelo no tiene nodos configurados en CPTs.
                        </div>
                    {% endif %}

                    <hr>
                    <button class="btn btn-success w-100" type="submit">
                        <i class="bi bi-lightning-charge"></i> Calcular Riesgo
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-8">
        {% if resultado %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom">
                <h4 class="mb-0 text-center">Diagnóstico de Riesgo</h4>
            </div>
            <div class="card-body text-center">
                
                <div class="mb-4">
                    <span class="text-muted">Nivel de Riesgo Calculado:</span>
                    <h1 class="display-4 fw-bold text-uppercase mt-2
                        {% if resultado.riesgo_clasificado == 'alto' %}text-danger
                        {% elif resultado.riesgo_clasificado == 'medio' %}text-warning
                        {% else %}text-success{% endif %}">
                        {{ resultado.riesgo_clasificado }}
                    </h1>
                    <p class="small text-muted">Calculado el: {{ resultado.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>

                <div class="row justify-content-center">
                    <div class="col-md-10">
                        <h6 class="text-start border-bottom pb-2">Distribución de Probabilidades</h6>
                        
                        {% if resultado_detalles %}
                            {% for target, probs in resultado_detalles.items() %}
                                <div class="mb-3">
                                    <strong>{{ target }}</strong>
                                    <div class="progress mt-2" style="height: 25px;">
                                        {% for estado, valor in probs.items() %}
                                            {% set color_bar = 'bg-secondary' %}
                                            {% if estado in ['Alta', 'OK', 'Operativo'] %}{% set color_bar = 'bg-success' %}
                                            {% elif estado in ['Media', 'Degradado'] %}{% set color_bar = 'bg-warning text-dark' %}
                                            {% elif estado in ['Baja', 'Fallo', 'Caido'] %}{% set color_bar = 'bg-danger' %}
                                            {% endif %}

                                            <div class="progress-bar {{ color_bar }}" role="progressbar" 
                                                 style="width: {{ (valor * 100)|round(1) ~ '%' }}" 
                                                 aria-valuenow="{{ (valor * 100)|round(1) }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ estado }}: {{ (valor * 100) | round(1) }}%
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">ID de Inferencia: #{{ resultado.id }} | Modelo: {{ modelo.nombre }}</small>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            <div>
                Seleccione las evidencias en el panel izquierdo y haga clic en "Calcular Riesgo" para ver el análisis.
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}