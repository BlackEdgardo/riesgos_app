{% extends "basic.html" %}

{% block title %}
Gestión de Empresas
{% endblock %}

{% block content %}

<div id="app" class="row">
  <div class="col-12">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="m-0 text-primary">
        <i class="fas fa-building me-2"></i>Empresas
      </h2>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#crearModal">
        <i class="fas fa-plus-circle me-1"></i> Nueva Empresa
      </button>
    </div>

    <div v-if="loading" class="alert alert-info text-center">
      <div class="spinner-border spinner-border-sm text-info me-2" role="status"></div>
      Cargando listado de empresas...
    </div>
    <div v-if="error" class="alert alert-danger">
      <i class="fas fa-exclamation-triangle me-2"></i> ${ error }
    </div>

    <div class="card shadow-sm" v-if="!loading && !error">
      <div class="card-body">
        <h5 class="card-title mb-3">Listado Registrado</h5>
        
        <div class="table-responsive">
          <table id="empresasTable" class="table table-hover table-striped border align-middle" style="width:100%">
            <thead class="table-light">
              <tr>
                <th style="width: 5%">ID</th>
                <th style="width: 35%">Razón Social</th>
                <th style="width: 20%">RUC</th>
                <th style="width: 20%">Sector</th>
                <th style="width: 20%" class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="emp in empresas" :key="emp.id">
                <td>${ emp.id }</td>
                <td class="fw-bold text-dark">${ emp.nombre }</td>
                <td>
                    <span v-if="emp.ruc" class="font-monospace">${ emp.ruc }</span>
                    <span v-else class="text-muted small"><em>—</em></span>
                </td>
                <td>
                  <span v-if="emp.sector" class="badge bg-secondary">${ emp.sector }</span>
                  <span v-else class="text-muted small">Sin asignar</span>
                </td>
                <td class="text-end">
                  <button @click="prepararEdicion(emp)" 
                          class="btn btn-sm btn-outline-warning me-1"
                          title="Editar información">
                    <i class="fas fa-edit"></i>
                  </button>

                  <button @click="confirmarEliminar(emp)" 
                          class="btn btn-sm btn-outline-danger"
                          data-bs-toggle="modal" 
                          data-bs-target="#eliminarModal"
                          title="Eliminar registro">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="crearModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form action="{{ url_for('company.nueva_empresa') }}" method="POST" class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Registrar Nueva Empresa</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label fw-bold">Razón Social <span class="text-danger">*</span></label>
              <input type="text" name="nombre" class="form-control" required placeholder="Ej: Minera Las Bambas S.A.">
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">RUC</label>
                  <input type="text" name="ruc" class="form-control" placeholder="11 dígitos" maxlength="11" pattern="\d{11}">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Sector</label>
                  <select name="sector" class="form-select">
                    <option value="">-- Seleccionar --</option>
                    <option value="Minería">Minería</option>
                    <option value="Banca y Finanzas">Banca y Finanzas</option>
                    <option value="Construcción">Construcción</option>
                    <option value="Retail">Retail</option>
                    <option value="Tecnología">Tecnología</option>
                    <option value="Salud">Salud</option>
                    <option value="Otro">Otro</option>
                  </select>
                </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Empresa</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="editarModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form v-if="empresaEditando" 
              :action="'/empresas/' + empresaEditando.id + '/editar'" 
              method="POST" 
              class="modal-content">
          
          <div class="modal-header bg-warning bg-opacity-25">
            <h5 class="modal-title">Editar Empresa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          
          <div class="modal-body">
            <div class="alert alert-light border py-1 mb-3 small text-muted">
              Editando ID: <strong>${ empresaEditando.id }</strong>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Razón Social <span class="text-danger">*</span></label>
              <input type="text" name="nombre" v-model="empresaEditando.nombre" class="form-control" required>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">RUC</label>
                    <input type="text" name="ruc" v-model="empresaEditando.ruc" class="form-control" maxlength="11">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Sector</label>
                    <select name="sector" v-model="empresaEditando.sector" class="form-select">
                        <option value="">-- Seleccionar --</option>
                        <option value="Minería">Minería</option>
                        <option value="Banca y Finanzas">Banca y Finanzas</option>
                        <option value="Construcción">Construcción</option>
                        <option value="Retail">Retail</option>
                        <option value="Tecnología">Tecnología</option>
                        <option value="Salud">Salud</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-warning">Actualizar Datos</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="eliminarModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirmar Eliminación</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" v-if="empresaAEliminar">
            <p>¿Estás seguro de que deseas eliminar la empresa:</p>
            <div class="alert alert-secondary text-center fw-bold">
              ${ empresaAEliminar.nombre }
            </div>
            <p class="text-danger small mb-0">
              <i class="fas fa-exclamation-circle"></i> Esta acción es irreversible.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <form v-if="empresaAEliminar" 
                  :action="'/empresas/' + empresaAEliminar.id + '/eliminar'" 
                  method="POST">
              <button type="submit" class="btn btn-danger">Sí, Eliminar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
new Vue({
  el: '#app',
  delimiters: ['${', '}'], // Importante para no chocar con Jinja2
  data() {
    return {
      empresas: [],
      loading: true,
      error: null,
      
      // Variables temporales para edición/eliminación
      empresaEditando: null,
      empresaAEliminar: null,
      
      // Referencias a objetos
      dataTable: null,
      bsModalEditar: null
    }
  },
  mounted() {
    this.cargarDatos();
  },
  methods: {
    cargarDatos() {
      fetch('/empresas/json')
        .then(res => {
          if(!res.ok) throw new Error("Error en la respuesta del servidor");
          return res.json();
        })
        .then(data => {
          this.empresas = data;
          this.loading = false;
          
          // Inicializar DataTables despues de que Vue renderice el DOM
          this.$nextTick(() => {
            this.initDataTable();
          });
        })
        .catch(err => {
          console.error(err);
          this.error = "No se pudieron cargar las empresas.";
          this.loading = false;
        });
    },

    initDataTable() {
      // Si ya existe, lo destruimos para reinicializar
      if (this.dataTable) {
        this.dataTable.destroy();
      }
      
      this.dataTable = $('#empresasTable').DataTable({
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
        },
        responsive: true,
        pageLength: 10,
        order: [[0, 'desc']] // Ordenar por ID descendente (nuevos primero)
      });
    },

    prepararEdicion(empresa) {
      // 1. Clonamos el objeto para no modificar la fila de la tabla en tiempo real
      this.empresaEditando = JSON.parse(JSON.stringify(empresa));
      
      // 2. Abrimos el modal usando la API de JS de Bootstrap 5
      // Esto asegura que funcione bien incluso si el modal estaba oculto
      const modalElement = document.getElementById('editarModal');
      if (modalElement) {
        this.bsModalEditar = new bootstrap.Modal(modalElement);
        this.bsModalEditar.show();
      }
    },

    confirmarEliminar(empresa) {
      this.empresaAEliminar = empresa;
    }
  }
});
</script>

{% endblock %}